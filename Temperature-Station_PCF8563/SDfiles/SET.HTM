<!DOCTYPE html>
<html>
 <title>Temperature Station</title>
  <head>
    <meta http-equiv="cache-control" content="no-cache" />
    <style>table,th,td {border: 1px solid black;text-align: center}</style>
  </head>
  <body onload="loadSettings()">
    <a href="/">
    <button>Strona glowna</button>
    </a>
    <form method="POST" id="general" a="/settings">
      <table align="center">
        <caption>General settings</caption>
        <input type="hidden" id="a" name="a">
        <input type="hidden" id="_oD" value="0" name="oD">
        <tr>
          <td>Name:</td>
          <td><input type="text" id="sN" size="20" name="sN"></td>
        </tr>
        <tr>
          <td>SSID:</td>
          <td><input type="text" id="sS" size="20" name="sS"></td>
        </tr>
        <tr>
          <td>WPA2 Key:</td>
          <td><input type="text" id="sW" size="20" name="sW"></td>
        </tr>
        <tr>
          <td>Login:</td>
          <td><input type="text" id="sL" size="20" name="sL"></td>
        </tr>
        <tr>
          <td>Pasword:</td>
          <td><input type="password" id="sP" size="20" name="sP"></td>
        </tr>
        <tr>
          <td>New login:</td>
          <td><input type="text" id="nL" size="20" name="nL"></td>
        </tr>
        <tr>
          <td>New pasword:</td>
          <td><input type="password" id="nP" size="20" name="nP"></td>
        </tr>
        <tr>
          <td>Repeat Pasword:</td>
          <td><input type="password" id="rP" size="20" name="rP"></td>
        </tr>
        <tr>
          <td>Network SSID:</td>
          <td><input type="text" id="oS" size="20" name="oS"></td>
        </tr>
        <tr>
          <td>Network Passphrase:</td>
          <td><input type="text" id="oP" size="20" name="oP"></td>
        </tr>
        <tr>
          <td>IP Address:</td>
          <td><input type="text" id="oI" size="20" name="oI"></td>
        </tr>
        <tr>
          <td>Gateway:</td>
          <td><input type="text" id="oG" size="20" name="oG"></td>
        </tr>
        <tr>
          <td>Broadcast:</td>
          <td><input type="text" id="oM" size="20" name="oM"></td>
        </tr>
        <tr>
          <td>Use DHCP:</td>
          <td><input type="checkbox" id="oD" value="1" name="oD">Enable</td>
        </tr>
      </table>
      <input type="button" align="center" onclick="saveGen()" value="Save">
      <input type="button" align="center" onclick="testGen()" value="Test">
    </form>
    <br>
    <form method="POST" id="time" a="/time">
      <table align="center">
        <caption>Time related settings</caption>
        <input type="hidden" id="a" name="a">
        <input type="hidden" id="ep" name="ep">
        <input type="hidden" id="_uN" value="0" name="uN">
        <tr>
          <td>Date and time:</td>
          <td><input type="datetime-local" id="datetime" name="datetime" min="2000-01-01T00:00"></td>
        </tr>
        <tr>
          <td>Timezone:</td>
          <td><input type="text" id="tz" size="20" name="tz"></td>
        </tr>
        <tr>
          <td>Use NTP Server:</td>
          <td><input type="checkbox" id="uN" value="1" name="uN"></td>
        </tr>
        <tr>
          <td>NTP Server:</td>
          <td><input type="text" id="nS" name="nS"></td>
        </tr>
      </table>
      <input type="button" align="center" onclick="saveTime()" value="Save">
      <input type="button" align="center" onclick="getUserTime()" value="Get user time">
      <input type="button" align="center" onclick="testTime()" value="Test">
    </form>
    <input type="button" align="center" onclick="reset()" value="Defaults">
    <br>
    <script>
      function loadSettings() {
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", "/settings", true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send("a=l");
      xhttp.onreadystatechange = function() {
      console.log(xhttp.responseText);
      var resp = JSON.parse(xhttp.responseText);
      document.getElementById("sN").value = resp.sN;
      document.getElementById("sS").value = resp.sS;
      document.getElementById("sL").value = resp.sL;
      document.getElementById("oS").value = resp.oS;
      document.getElementById("oI").value = resp.oI;
      document.getElementById("oG").value = resp.oG;
      document.getElementById("oM").value = resp.oM;
      document.getElementById("oD").checked = resp.oD;
      document.getElementById("uN").checked = resp.uN;
      document.getElementById("nS").value = resp.nS;
      document.getElementById("tz").value = resp.tz;
      };
      return;
      }
      function reset() {
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", "/settings", true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send("a=r");
      return;
      }
      
      function uploadGen(toDo = undefined) {
      var tmp = document.getElementById("oI").value;
      if (!(/^[0-9.]+$/.test(tmp)) || (tmp.replace(/[^.]/g, "").length != 3) || tmp.length > 15) {
      submitOK = false;
	  alert("Incorrect IP address!");
      }
	  tmp = document.getElementById("oG").value;
      if (!(/^[0-9.]+$/.test(tmp)) || (tmp.replace(/[^.]/g, "").length != 3) || tmp.length > 15) {
      submitOK = false;
	  alert("Incorrect gateway address!");
      }
	  tmp = document.getElementById("oM").value;
      if (!(/^[0-9.]+$/.test(tmp)) || (tmp.replace(/[^.]/g, "").length != 3) || tmp.length > 15) {
      submitOK = false;
	  alert("Incorrect subnet mask!");
      }
	  tmp = document.getElementById("tz").value;
	  if(tmp < -12 || tmp > 12){
	  submitOK = false;
	  alert("Check tz");
	  }
	  tmp = document.getElementById("nP").value;
	  var tmp2 = document.getElementById("rP").value;
	  if(tmp == undefined || tmp2 == undefined){
	  document.getElementById("nP").disabled = true;
	  document.getElementById("rP").disabled = true;
	  } else if(tmp != tmp2){
	  submitOK = false;
	  alert("Passwords don't match");
	  } else document.getElementById("rP").disabled = true;
	  tmp = document.getElementById("nL").value;
	  if(tmp == undefined)
	  document.getElementById("nL").disabled = true;
	  if (document.getElementById("nL").value == undefined)
      document.getElementById("nL").disabled = true;
	  if (document.getElementById("nP").value == undefined)
      document.getElementById("nP").disabled = true;
	  if (document.getElementById("rP").value == undefined)
      document.getElementById("rP").disabled = true;
      
      if (document.getElementById("oD").checked)
      document.getElementById("_oD").disabled = true;
      else document.getElementById("oD").disabled = true;
  
      if (toDo != undefined) {
      document.getElementById("action").disabled = false;
      document.getElementById("action").value = toDo;
      }
      document.forms.general.action.value = toDo;
      var f = document.forms.general;
      console.log(f.action.value);
      var postData = [];
      for (var i = 0; i < f.elements.length; i++) {
      if (f.elements[i].value != "" && f.elements[i].name != "" && !f.elements[i].disabled)
      postData.push(f.elements[i].name + "=" + f.elements[i].value);
      }
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/settings", true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send(postData.join("&"));
      
	  document.getElementById("nP").disabled = false;
	  document.getElementById("rP").disabled = false;
      document.getElementById("nL").disabled = false;
      document.getElementById("_oD").disabled = false;
      document.getElementById("oD").disabled = false;
      return;
      }
      function saveGen() {
      uploadGen("s");
      return;
      }
      function testGen() {
      uploadGen("t");
      return;
      }
      
      function uploadTime(toDo = undefined) {
      if (document.getElementById("uN").checked)
      document.getElementById("_uN").disabled = true;
      else document.getElementById("uN").disabled = true;
      
      if (toDo != undefined) {
      document.getElementById("action").disabled = false;
      document.getElementById("action").value = toDo;
      }
      
      document.forms.time.action.value = toDo;
      var g = document.forms.time;
      console.log(g.action.value);
      var postData = [];

      var epo = new Date(document.getElementById("datetime").value).getTime();
      document.getElementById("datetime").disabled = true;
      document.getElementById("ep").value = (epo / 1000);
      
      for (var i = 0; i < g.elements.length; i++) {
      if (g.elements[i].value != "" && g.elements[i].name != "" && g.elements[i].disabled == false) {
      postData.push(g.elements[i].name + "=" + g.elements[i].value);
      console.log(g.elements[i].name + "=" + g.elements[i].value);
      }
      }
      document.getElementById("datetime").disabled = false;
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/time", true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send(postData.join("&"));
      
      document.getElementById("_uN").disabled = false;
      document.getElementById("uN").disabled = false;
      return;
      }
      function saveTime() {
      uploadTime("s");
      return;
      }
      function testTime() {
      var ep = new Date(document.getElementById("datetime").value).getTime();
      document.getElementById("datetime").disabled = true;
      document.getElementById("ep").value = (ep / 1000);
      uploadTime("t");
      document.getElementById("datetime").disabled = false;
      return;
      }
    </script>
  </body>
</html>