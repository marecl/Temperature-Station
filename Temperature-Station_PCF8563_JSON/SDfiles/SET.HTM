<!DOCTYPE html>
<html>
	<title> Temperature Station </title>
	<body onload="loadSettings()">
		<form method ="POST" id="general" action="/settings">
			Name:				<input type="text" id="selfName" size="20" name="selfName"><br>
			SSID:				<input type="text" id="selfSSID" size="20" name="selfSSID"><br>
			Self AP:			<input type="checkbox" id="selfAP" value=true name="selfAP"><br>
								<input type="hidden" id="_selfAP" value="0" name="selfAP">
			WPA2 Key: 			<input type="text" id="selfWPA2" size="20" name="selfWPA2"><br>
			Login: 				<input type="text" id="selfLOGIN" size="20" name="selfLOGIN"><br>
			Pasword:			<input type="password" id="selfPASS" size="20" name="selfPASS"><br>
			Repeat Pasword:		<input type="password" id="repeatPASS" size="20" name="repeatPASS"><br>
			Network SSID:		<input type="text" id="outSSID" size="20" name="outSSID"><br>
			Network Passphrase:	<input type="text" id="outPASS" size="20" name="outPASS"><br>
			IP Address: 		<input type="text" id="outIP" size="20" name="outIP"><br>
			Gateway:			<input type="text" id="outGW" size="20" name="outGW"><br>
			Broadcast: 			<input type="text" id="outMASK" size="20" name="outMASK"><br>
			Use DHCP:			<input type="checkbox" id="outDHCP" value="1" name="outDHCP"><br>
								<input type="hidden" id="_outDHCP" value="0" name="outDHCP">
			Use NTP Server:		<input type="checkbox" id="useNTP" value="1" name="useNTP"><br>
								<input type="hidden" id="_useNTP" value="0" name="useNTP">
			NTP Server: 		<input type="text" id="ntpServer" name="ntpServer"><br>
			Timezone: 			<input type="text" id="timezone" size="20" name="timezone"><br>
								<input type="hidden" id="action" name="action">
								<input type="datetime-local" id="datetime" name="timeset" min="2000-01-01T00:00">
								<input type="button" onclick="saveSettings()" value="Save">
								<input type="button" onclick="test()" value="Test">
								<input type="button" onclick="reset()" value="Defaults">
		</form>
		<script>
			function loadSettings() {
				var xhttp = new XMLHttpRequest();
				xhttp.open("POST", "/settings", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send("action=load");
				xhttp.onreadystatechange = function() {
					console.log(xhttp.responseText);
					var resp = JSON.parse(xhttp.responseText);
					document.getElementById("selfName").value = resp.selfName;
					document.getElementById("selfSSID").value = resp.selfSSID;
					document.getElementById("selfLOGIN").value = resp.selfLOGIN;
					document.getElementById("outSSID").value = resp.outSSID;
					document.getElementById("outIP").value = resp.outIP;
					document.getElementById("outGW").value = resp.outGW;
					document.getElementById("outMASK").value = resp.outMASK;
					document.getElementById("outDHCP").checked = resp.outDHCP;
					document.getElementById("useNTP").checked = resp.useNTP;
					document.getElementById("ntpServer").value = resp.ntpServer;
					document.getElementById("timezone").value = resp.timezone;
					document.getElementById("selfAP").value = resp.selfAP;
				};
				return;
			}
			
			function reset() {
				var xhttp = new XMLHttpRequest();
				xhttp.open("POST", "/settings", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send("action=reset");
				return;
			}
			
			function uploadSettings(toDo = undefined) {
				var submitOK = true;
				var tmp = document.getElementById("outIP").value;
				
				if(!(/^[0-9.]+$/.test(tmp)) || (tmp.replace(/[^.]/g, "").length != 3) || tmp.length > 15){
					submitOK = false;
				}
				
				if(document.getElementById("selfName").value == ""){
					document.getElementById("selfName").disabled = true;
				}
				if(document.getElementById("selfSSID").value == ""){
					document.getElementById("selfSSID").disabled = true;
				}
				if(document.getElementById("selfLOGIN").value == ""){
					document.getElementById("selfLOGIN").disabled = true;
				}
				if(document.getElementById("outSSID").value == ""){
					document.getElementById("outSSID").disabled = true;
				}
				if(document.getElementById("outIP").value == ""){
					document.getElementById("outIP").disabled = true;
				}
				if(document.getElementById("outGW").value == ""){
					document.getElementById("outGW").disabled = true;
				}
				if(document.getElementById("outMASK").value == ""){
					document.getElementById("outMASK").disabled = true;
				}
				if(document.getElementById("outDHCP").checked) {
					document.getElementById("_outDHCP").disabled = true;
				}
				if(document.getElementById("selfAP").checked) {
					document.getElementById("_selfAP").disabled = true;
				}
				if(document.getElementById("useNTP").checked) {
					document.getElementById("_useNTP").disabled = true;
				}
				if(document.getElementById("ntpServer").value == ""){
					document.getElementById("ntpServer").disabled = true;
				}
				if(document.getElementById("timezone").value == ""){
					document.getElementById("timezone").disabled = true;
				}
				if(document.getElementById("selfPASS").value == ""){
					document.getElementById("selfPASS").disabled = true;
				}
				if(document.getElementById("selfWPA2").value == ""){
					document.getElementById("selfWPA2").disabled = true;
				}
				if(document.getElementById("selfPASS").value == ""){
					document.getElementById("selfPASS").disabled = true;
					var selfp, repp;
					selfp = document.getElementById("selfPASS").value;
					repp = document.getElementById("repeatPASS").value;
					if(selfp != repp) {
						submitOK = false;
						alert("Passwords don't match");
					}
				}
				if(document.getElementById("outPASS").value == ""){
					document.getElementById("outPASS").disabled = true;
				}
				if(document.getElementById("datetime").value == ""){
					document.getElementById("datetime").disabled = true;
				}
				document.getElementById("repeatPASS").disabled = true;
				if(toDo != undefined) {
					document.getElementById("action").disabled = false;
					document.getElementById("action").value = toDo;
				}
				if(submitOK) {
					document.getElementById("general").submit();
				} else {
					document.getElementById("selfName").disabled = false;
					document.getElementById("selfSSID").disabled = false;
					document.getElementById("selfLOGIN").disabled = false;
					document.getElementById("outSSID").disabled = false;
					document.getElementById("outIP").disabled = false;
					document.getElementById("outGW").disabled = false;
					document.getElementById("outMASK").disabled = false;
					document.getElementById("_outDHCP").disabled = false;
					document.getElementById("_useNTP").disabled = false;
					document.getElementById("ntpServer").disabled = false;
					document.getElementById("timezone").disabled = false;
					document.getElementById("selfPASS").disabled = false;
					document.getElementById("selfWPA2").disabled = false;
					document.getElementById("selfPASS").disabled = false;
					document.getElementById("_selfAP").disabled = false;
				}
				return;
			}
			
			function saveSettings() {
				uploadSettings("save");
				return;
			}
			function test() {
				console.log(document.getElementById("datetime").value);
				var epoch = new Date(document.getElementById("datetime").value).getTime();
				console.log(epoch);
				uploadSettings("test");
				return;
			}
		</script>
	</body>
</html>